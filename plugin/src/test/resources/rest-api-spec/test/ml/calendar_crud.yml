---
"Test calendar CRUD":

  - do:
      xpack.ml.put_job:
        job_id: cal-job
        body:  >
          {
            "analysis_config" : {
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
            }
          }
  - match: { job_id: "cal-job" }

  - do:
      xpack.ml.put_job:
        job_id: cal-job2
        body:  >
          {
            "analysis_config" : {
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
            }
          }
  - match: { job_id: "cal-job2" }


  - do:
      xpack.ml.put_calendar:
        calendar_id: "advent"
        body:  >
          {
            "job_ids": ["cal-job", "cal-job2"]
          }
  - match: { calendar_id: advent }
  - match: { job_ids.0: cal-job }
  - match: { job_ids.1: cal-job2 }

  - do:
      xpack.ml.get_calendars:
        calendar_id: "advent"
  - match: { count: 1 }
  - match:
      calendars.0:
        calendar_id: "advent"
        job_ids: ["cal-job", "cal-job2"]
  - is_false: type

  - do:
      xpack.ml.put_calendar:
        calendar_id: "Dogs of the Year"
        body:  >
          {
            "job_ids": ["cal-job"]
          }

  - do:
      xpack.ml.put_calendar:
        calendar_id: "Cats of the Year"

  - do:
      xpack.ml.get_calendars: {}
  - match: { count: 3 }

  - do:
      xpack.ml.delete_calendar:
        calendar_id: "Dogs of the Year"

  - do:
      xpack.ml.get_calendars: {}
  - match: { count: 2 }

  - do:
      xpack.ml.get_calendars:
        calendar_id: _all
  - match: { count: 2 }

  - do:
      catch: missing
      xpack.ml.get_calendars:
        calendar_id: "Dogs of the Year"

  - do:
      catch: missing
      xpack.ml.put_calendar:
        calendar_id: "new cal with unknown job"
        body:  >
          {
            "job_ids": ["cal-job", "unknown-job"]
          }

---
"Test PageParams":
  - do:
      xpack.ml.put_calendar:
        calendar_id: "Calendar1"
  - do:
      xpack.ml.put_calendar:
        calendar_id: "Calendar2"
  - do:
      xpack.ml.put_calendar:
        calendar_id: "Calendar3"

  - do:
      xpack.ml.get_calendars:
        from: 2
  - match: { count: 3 }
  - length: { calendars: 1}
  - match: { calendars.0.calendar_id: Calendar3 }

  - do:
      xpack.ml.get_calendars:
        from: 1
        size: 1
  - match: { count: 3 }
  - length: { calendars: 1}
  - match: { calendars.0.calendar_id: Calendar2 }

---
"Test PageParams with ID is invalid":
  - do:
      catch: bad_request
      xpack.ml.get_calendars:
        calendar_id: Tides
        size: 10

---
"Test cannot overwrite an exisiting calendar":

  - do:
      xpack.ml.put_calendar:
        calendar_id: "Mayan"

  - do:
      catch: /version_conflict_engine_exception/
      xpack.ml.put_calendar:
        calendar_id: "Mayan"

---
"Test cannot create calendar with name _all":
  - do:
      catch: bad_request
      xpack.ml.put_calendar:
        calendar_id: "_all"

---
"Test deleted job is removed from calendar":

  - do:
      xpack.ml.put_job:
        job_id: cal-crud-test-delete
        body:  >
          {
            "analysis_config" : {
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
            }
          }
  - match: { job_id: "cal-crud-test-delete" }

  - do:
      xpack.ml.put_calendar:
        calendar_id: "delete-test"
        body:  >
          {
            "job_ids": ["cal-crud-test-delete"]
          }

  - do:
      xpack.ml.delete_job:
        job_id: cal-crud-test-delete
  - match: { acknowledged: true }

  - do:
      xpack.ml.get_calendars:
        calendar_id: "delete-test"
  - match: { count: 1 }
  - match: { calendars.0.job_ids: [] }

---
"Test update calendar job ids":

  - do:
      xpack.ml.put_calendar:
        calendar_id: "Wildlife"

  - do:
      xpack.ml.put_job:
        job_id: tiger
        body:  >
          {
            "analysis_config" : {
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
            }
          }
  - match: { job_id: "tiger" }

  - do:
      xpack.ml.put_calendar_job:
        calendar_id: "Wildlife"
        job_id: "tiger"
  - match: { calendar_id: "Wildlife" }
  - match: { job_ids.0: "tiger" }

  - do:
      xpack.ml.get_calendars:
        calendar_id: "Wildlife"
  - match: { count: 1 }
  - match: { calendars.0.calendar_id: "Wildlife" }
  - length: { calendars.0.job_ids: 1 }
  - match: { calendars.0.job_ids.0: "tiger" }

  - do:
      xpack.ml.delete_calendar_job:
        calendar_id: "Wildlife"
        job_id: "tiger"

  - do:
      xpack.ml.get_calendars:
        calendar_id: "Wildlife"
  - match: { count: 1 }
  - match: { calendars.0.calendar_id: "Wildlife" }
  - length: { calendars.0.job_ids: 0 }

  - do:
      catch: missing
      xpack.ml.put_calendar_job:
        calendar_id: "Wildlife"
        job_id: "missing job"

  - do:
      catch: missing
      xpack.ml.delete_calendar_job:
        calendar_id: "Wildlife"
        job_id: "missing job"

---
"Test calendar get events":

  - do:
      xpack.ml.put_calendar:
        calendar_id: "events"

  - do:
      xpack.ml.post_calendar_events:
        calendar_id: "events"
        body: >
          { "description": "event 1", "start_time": "2017-12-01T00:00:00Z", "end_time": "2017-12-02T00:00:00Z", "calendar_id": "events" }
          { "description": "event 2", "start_time": "2017-12-05T00:00:00Z", "end_time": "2017-12-06T00:00:00Z", "calendar_id": "events" }
          { "description": "event 3", "start_time": "2017-12-12T00:00:00Z", "end_time": "2017-12-13T00:00:00Z", "calendar_id": "events" }
          { "description": "event 4", "start_time": "2017-12-12T00:00:00Z", "end_time": "2017-12-15T00:00:00Z", "calendar_id": "events" }

  - do:
      xpack.ml.get_calendar_events:
        calendar_id: "events"
  - length: { events: 4 }
  - match: { events.0.description: "event 1" }
  - match: { events.1.description: "event 2" }
  - match: { events.2.description: "event 3" }
  - match: { events.3.description: "event 4" }
  - is_true: events.0.event_id
  - set: { events.0.event_id: event_1_id }

  - do:
      xpack.ml.get_calendar_events:
        calendar_id: "events"
        from: 1
        size: 2
  - length: { events: 2 }
  - match: { events.0.description: "event 2" }
  - match: { events.1.description: "event 3" }

  - do:
      xpack.ml.get_calendar_events:
        calendar_id: "events"
        end: "2017-12-12T00:00:00Z"
  - length: { events: 2 }
  - match: { events.0.description: "event 1" }
  - match: { events.1.description: "event 2" }

  - do:
      xpack.ml.get_calendar_events:
        calendar_id: "events"
        start: "2017-12-05T03:00:00Z"
  - length: { events: 3 }
  - match: { events.0.description: "event 2" }
  - match: { events.1.description: "event 3" }
  - match: { events.2.description: "event 4" }

  - do:
      xpack.ml.get_calendar_events:
        calendar_id: "events"
        start: "2017-12-02T00:00:00Z"
        end: "2017-12-12T00:00:00Z"
  - length: { events: 1 }
  - match: { events.0.description: "event 2" }

  - do:
      xpack.ml.put_calendar:
        calendar_id: "events-2"

  - do:
      xpack.ml.post_calendar_events:
        calendar_id: "events-2"
        body: >
          { "description": "event 21", "start_time": "2017-12-02T00:00:00Z", "end_time": "2017-12-02T05:00:00Z"}
          { "description": "event 22", "start_time": "2017-12-25T00:00:00Z", "end_time": "2017-12-26T00:00:00Z"}

  - do:
      catch: bad_request
      xpack.ml.post_calendar_events:
        calendar_id: "events-2"
        body: >
          { "description": "event 21", "start_time": "2017-12-02T00:00:00Z", "end_time": "2017-12-03T00:00:00Z", "calendar_id": "events"}

# Event is not in calendar events-2
  - do:
      catch: bad_request
      xpack.ml.delete_calendar_event:
        calendar_id: "events-2"
        event_id: $event_1_id

  - do:
      xpack.ml.delete_calendar_event:
        calendar_id: "events"
        event_id: $event_1_id

  - do:
      catch: missing
      xpack.ml.delete_calendar_event:
        calendar_id: "events"
        event_id: "missing event"


---
"Test delete calendar deletes events":

  - do:
      xpack.ml.put_calendar:
        calendar_id: "cal-foo"

  - do:
      xpack.ml.post_calendar_events:
        calendar_id: "cal-foo"
        body: >
          { "description": "event 1", "start_time": "2017-12-01T00:00:00Z", "end_time": "2017-12-02T00:00:00Z" }
          { "description": "event 2", "start_time": "2017-12-05T00:00:00Z", "end_time": "2017-12-06T00:00:00Z" }
          { "description": "event 2", "start_time": "2017-12-05T00:00:00Z", "end_time": "2017-12-06T00:00:00Z" }

  - do:
      xpack.ml.put_calendar:
        calendar_id: "cal-bar"

  - do:
      xpack.ml.post_calendar_events:
        calendar_id: "cal-bar"
        body: >
          { "description": "event 21", "start_time": "2017-12-02T00:00:00Z", "end_time": "2017-12-02T05:00:00Z"}
          { "description": "event 22", "start_time": "2017-12-25T00:00:00Z", "end_time": "2017-12-26T00:00:00Z"}

  - do:
      xpack.ml.delete_calendar:
        calendar_id: "cal-foo"

# Check the event from calendar 1 is deleted
  - do:
      count:
        index: .ml-meta
        body:
          query:
            constant_score:
              filter:
                term:
                  type: scheduled_event
  - match: { count: 2 }

  - do:
      count:
        index: .ml-meta
        body:
          query:
            bool:
              must:
                - term:
                    type: scheduled_event
                - term:
                    calendar_id: cal-foo
  - match: { count: 0 }

---
"Test get all calendar events":

  - do:
      xpack.ml.put_calendar:
        calendar_id: "dave-holidays"

  - do:
      xpack.ml.post_calendar_events:
        calendar_id: "dave-holidays"
        body: >
          { "description": "xmas", "start_time": "2017-12-25T00:00:00Z", "end_time": "2017-12-26T00:00:00Z" }
          { "description": "ny", "start_time": "2018-01-01T00:00:00Z", "end_time": "2018-01-02T00:00:00Z" }

  - do:
      xpack.ml.put_calendar:
        calendar_id: "tom-holidays"

  - do:
      xpack.ml.post_calendar_events:
        calendar_id: "tom-holidays"
        body: >
          { "description": "xmas", "start_time": "2017-12-20T00:00:00Z", "end_time": "2017-12-26T00:00:00Z" }
          { "description": "other", "start_time": "2017-12-27T00:00:00Z", "end_time": "2018-01-02T00:00:00Z" }

  - do:
      xpack.ml.get_calendar_events:
        calendar_id: "_all"
  - length: { events: 4 }

---
"Test get calendar events for job":

  - do:
      xpack.ml.put_job:
        job_id: cal-crud-job-with-events
        body:  >
          {
            "analysis_config" : {
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
            }
          }

  - do:
      xpack.ml.put_calendar:
        calendar_id: "dave-holidays"
        body: >
          {
            "job_ids": ["cal-crud-job-with-events"]
          }

  - do:
      xpack.ml.post_calendar_events:
        calendar_id: "dave-holidays"
        body: >
          { "description": "xmas", "start_time": "2017-12-25T00:00:00Z", "end_time": "2017-12-26T00:00:00Z" }
          { "description": "ny", "start_time": "2018-01-01T00:00:00Z", "end_time": "2018-01-02T00:00:00Z" }

  - do:
      xpack.ml.put_calendar:
        calendar_id: "tom-holidays"
        body: >
          {
            "job_ids": ["cal-crud-job-with-events"]
          }

  - do:
      xpack.ml.post_calendar_events:
        calendar_id: "tom-holidays"
        body: >
          { "description": "xmas", "start_time": "2017-12-20T00:00:00Z", "end_time": "2017-12-26T00:00:00Z" }
          { "description": "other", "start_time": "2018-01-15T00:00:00Z", "end_time": "2018-01-16T00:00:00Z" }

  - do:
      xpack.ml.put_calendar:
        calendar_id: "not-used-by-job"

  - do:
      xpack.ml.post_calendar_events:
        calendar_id: "not-used-by-job"
        body: >
          { "description": "random", "start_time": "2018-01-20T00:00:00Z", "end_time": "2018-01-26T00:00:00Z" }
          { "description": "random2", "start_time": "2018-02-20T00:00:00Z", "end_time": "2018-02-26T00:00:00Z" }


# Calendar Id must be _all if a job id is used
  - do:
      catch: /action_request_validation_exception/
      xpack.ml.get_calendar_events:
        calendar_id: "dave-holiday"
        job_id: cal-crud-job-with-events

  - do:
      xpack.ml.get_calendar_events:
        calendar_id: _all
        job_id: cal-crud-job-with-events
  - match: { count: 4 }
  - length: { events: 4 }

  - do:
      xpack.ml.get_calendar_events:
        calendar_id: _all
        start: "2018-01-01T00:00:00Z"
        job_id: cal-crud-job-with-events
  - match: { count: 2 }
  - length: { events: 2 }
  - match: { events.0.description: ny }
  - match: { events.1.description: other }

---
"Test get calendar events with job groups":
# Test job group
  - do:
      xpack.ml.put_job:
        job_id: cal-crud-job-with-events-group
        body:  >
          {
            "analysis_config" : {
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
            },
            "groups" : ["ben-holidays-group"]
          }

  - do:
      xpack.ml.put_calendar:
        calendar_id: "ben-holidays"
        body: >
          {
            "job_ids": ["ben-holidays-group"]
          }

  - do:
      xpack.ml.post_calendar_events:
        calendar_id: "ben-holidays"
        body: >
          { "description": "ski", "start_time": "2018-01-20T00:00:00Z", "end_time": "2018-01-27T00:00:00Z" }
          { "description": "snow", "start_time": "2018-01-30T00:00:00Z", "end_time": "2018-02-01T00:00:00Z" }

  - do:
      xpack.ml.get_calendar_events:
        calendar_id: _all
        job_id: "cal-crud-job-with-events-group"
  - match: { count: 2 }
  - length: { events: 2 }
  - match: { events.0.description: ski }
  - match: { events.1.description: snow }

  - do:
      xpack.ml.get_calendar_events:
        calendar_id: _all
        job_id: "ben-holidays-group"
  - match: { count: 2 }
  - length: { events: 2 }
  - match: { events.0.description: ski }
  - match: { events.1.description: snow }
