---
"Test calendar CRUD":

  - do:
      xpack.ml.put_job:
        job_id: cal-job
        body:  >
          {
            "analysis_config" : {
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
            }
          }
  - match: { job_id: "cal-job" }

  - do:
      xpack.ml.put_job:
        job_id: cal-job2
        body:  >
          {
            "analysis_config" : {
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
            }
          }
  - match: { job_id: "cal-job2" }


  - do:
      xpack.ml.put_calendar:
        calendar_id: "advent"
        body:  >
          {
            "job_ids": ["cal-job", "cal-job2"]
          }
  - match: { calendar_id: advent }
  - match: { job_ids.0: cal-job }
  - match: { job_ids.1: cal-job2 }

  - do:
      xpack.ml.get_calendars:
        calendar_id: "advent"
  - match: { count: 1 }
  - match:
      calendars.0:
        calendar_id: "advent"
        job_ids: ["cal-job", "cal-job2"]
  - is_false: type

  - do:
      xpack.ml.put_calendar:
        calendar_id: "Dogs of the Year"
        body:  >
          {
            "job_ids": ["cal-job"]
          }

  - do:
      xpack.ml.put_calendar:
        calendar_id: "Cats of the Year"

  - do:
      xpack.ml.get_calendars: {}
  - match: { count: 3 }

  - do:
      xpack.ml.delete_calendar:
        calendar_id: "Dogs of the Year"

  - do:
      xpack.ml.get_calendars: {}
  - match: { count: 2 }

  - do:
      catch: missing
      xpack.ml.get_calendars:
        calendar_id: "Dogs of the Year"

  - do:
      catch: missing
      xpack.ml.put_calendar:
        calendar_id: "new cal with unknown job"
        body:  >
          {
            "job_ids": ["cal-job", "unknown-job"]
          }

---
"Test PageParams":
  - do:
      xpack.ml.put_calendar:
        calendar_id: "Calendar1"
  - do:
      xpack.ml.put_calendar:
        calendar_id: "Calendar2"
  - do:
      xpack.ml.put_calendar:
        calendar_id: "Calendar3"

  - do:
      xpack.ml.get_calendars:
        from: 2
  - match: { count: 3 }
  - length: { calendars: 1}
  - match: { calendars.0.calendar_id: Calendar3 }

  - do:
      xpack.ml.get_calendars:
        from: 1
        size: 1
  - match: { count: 3 }
  - length: { calendars: 1}
  - match: { calendars.0.calendar_id: Calendar2 }

---
"Test PageParams with ID is invalid":
  - do:
      catch: bad_request
      xpack.ml.get_calendars:
        calendar_id: Tides
        size: 10

---
"Test cannot overwrite an exisiting calendar":

  - do:
      xpack.ml.put_calendar:
        calendar_id: "Mayan"

  - do:
      catch: /version_conflict_engine_exception/
      xpack.ml.put_calendar:
        calendar_id: "Mayan"

---
"Test cannot create calendar with name _all":
  - do:
      catch: bad_request
      xpack.ml.put_calendar:
        calendar_id: "_all"

---
"Test deleted job is removed from calendar":

  - do:
      xpack.ml.put_job:
        job_id: cal-crud-test-delete
        body:  >
          {
            "analysis_config" : {
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
            }
          }
  - match: { job_id: "cal-crud-test-delete" }

  - do:
      xpack.ml.put_calendar:
        calendar_id: "delete-test"
        body:  >
          {
            "job_ids": ["cal-crud-test-delete"]
          }

  - do:
      xpack.ml.delete_job:
        job_id: cal-crud-test-delete
  - match: { acknowledged: true }

  - do:
      xpack.ml.get_calendars:
        calendar_id: "delete-test"
  - match: { count: 1 }
  - match: { calendars.0.job_ids: [] }

---
"Test update calendar job ids":

  - do:
      xpack.ml.put_calendar:
        calendar_id: "Wildlife"

  - do:
      xpack.ml.put_job:
        job_id: tiger
        body:  >
          {
            "analysis_config" : {
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
            }
          }
  - match: { job_id: "tiger" }

  - do:
      xpack.ml.put_calendar_job:
        calendar_id: "Wildlife"
        job_id: "tiger"
  - match: { calendar_id: "Wildlife" }
  - match: { job_ids.0: "tiger" }

  - do:
      xpack.ml.get_calendars:
        calendar_id: "Wildlife"
  - match: { count: 1 }
  - match: { calendars.0.calendar_id: "Wildlife" }
  - length: { calendars.0.job_ids: 1 }
  - match: { calendars.0.job_ids.0: "tiger" }

  - do:
      xpack.ml.delete_calendar_job:
        calendar_id: "Wildlife"
        job_id: "tiger"

  - do:
      xpack.ml.get_calendars:
        calendar_id: "Wildlife"
  - match: { count: 1 }
  - match: { calendars.0.calendar_id: "Wildlife" }
  - length: { calendars.0.job_ids: 0 }

  - do:
      catch: missing
      xpack.ml.put_calendar_job:
        calendar_id: "Wildlife"
        job_id: "missing job"

  - do:
      catch: missing
      xpack.ml.delete_calendar_job:
        calendar_id: "Wildlife"
        job_id: "missing job"

---
"Test calendar events":

  - do:
      xpack.ml.put_calendar:
        calendar_id: "events"

  - do:
      xpack.ml.post_calendar_events:
        calendar_id: "events"
        body: >
          { "description": "event 1", "start_time": "2017-12-01T00:00:00Z", "end_time": "2017-12-02T00:00:00Z", "calendar_id": "events"}
          { "description": "event 2", "start_time": "2017-12-05T00:00:00Z", "end_time": "2017-12-06T00:00:00Z", "calendar_id": "events"}
          { "description": "event 3", "start_time": "2017-12-12T00:00:00Z", "end_time": "2017-12-13T00:00:00Z", "calendar_id": "events"}
          { "description": "event 4", "start_time": "2017-12-12T00:00:00Z", "end_time": "2017-12-15T00:00:00Z", "calendar_id": "events"}

  - do:
      xpack.ml.get_calendar_events:
        calendar_id: "events"
  - length: { special_events: 4 }
  - match: { special_events.0.description: "event 1" }
  - match: { special_events.1.description: "event 2" }
  - match: { special_events.2.description: "event 3" }
  - match: { special_events.3.description: "event 4" }

  - do:
      xpack.ml.get_calendar_events:
        calendar_id: "events"
        from: 1
        size: 2
  - length: { special_events: 2 }
  - match: { special_events.0.description: "event 2" }
  - match: { special_events.1.description: "event 3" }

  - do:
      xpack.ml.get_calendar_events:
        calendar_id: "events"
        before: "2017-12-12T00:00:00Z"
  - length: { special_events: 2 }
  - match: { special_events.0.description: "event 1" }
  - match: { special_events.1.description: "event 2" }

  - do:
      xpack.ml.get_calendar_events:
        calendar_id: "events"
        after: "2017-12-05T03:00:00Z"
  - length: { special_events: 3 }
  - match: { special_events.0.description: "event 2" }
  - match: { special_events.1.description: "event 3" }
  - match: { special_events.2.description: "event 4" }

  - do:
      xpack.ml.get_calendar_events:
        calendar_id: "events"
        after: "2017-12-02T00:00:00Z"
        before: "2017-12-12T00:00:00Z"
  - length: { special_events: 1 }
  - match: { special_events.0.description: "event 2" }
