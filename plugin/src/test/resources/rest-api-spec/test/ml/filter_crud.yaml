---
setup:
  - do:
      xpack.ml.put_filter:
        body:  >
          {
            "id": "filter-foo",
            "items": ["abc", "xyz"]
          }

  - do:
      xpack.ml.put_filter:
        body:  >
          {
            "id": "filter-foo2",
            "items": ["123", "lmnop"]
          }

  - do:
      indices.refresh: {}

---
"Test get filter API with bad ID":

  - do:
      catch: missing
      xpack.ml.get_filters:
        filter_id: "do_not_exist"

---
"Test get filter API":

  - do:
      xpack.ml.get_filters:
        filter_id: "filter-foo"

  - match: { count:   1 }
  - match:
      filters.0:
        id: "filter-foo"
        items: ["abc", "xyz"]

---
"Test get filters API":

  - do:
      xpack.ml.get_filters: {}

  - match: { count:   2 }
  - match:
      filters.0:
        id: "filter-foo"
        items: ["abc", "xyz"]

  - match:
      filters.1:
        id: "filter-foo2"
        items: ["123", "lmnop"]

  - do:
      xpack.ml.get_filters:
        from: 1
        size: 1

  - match: { count:   1 }

---
"Test invalid param combinations":

  - do:
      catch: request
      xpack.ml.get_filters:
        filter_id: "filter-foo"
        from: 0

  - do:
        catch: request
        xpack.ml.get_filters:
          filter_id: "filter-foo"
          size: 1

  - do:
        catch: request
        xpack.ml.get_filters:
          filter_id: "filter-foo"
          from: 0
          size: 1
---
"Test create filter api":
  - do:
      xpack.ml.put_filter:
        body:  >
          {
            "id": "filter-foo2",
            "items": ["abc", "xyz"]
          }

  - match: { acknowledged: true }

  - do:
      xpack.ml.get_filters:
        filter_id: "filter-foo2"

  - match: { count:   1 }
  - match:
      filters.0:
        id: "filter-foo2"
        items: ["abc", "xyz"]

---
"Test create filter api without ID":
  - do:
      catch: /illegal_argument_exception/
      xpack.ml.put_filter:
        body:  >
          {
            "items": ["abc", "xyz"]
          }

---
"Test delete in-use filter":
  - do:
      xpack.ml.put_job:
        job_id: filter-crud
        body:  >
          {
            "job_id":"filter-crud",
            "description":"Analysis of response time by airline",
            "analysis_config" : {
                "bucket_span": "3600s",
                "detectors" :[{"function":"mean","field_name":"airline",
                  "detector_rules": [
                    {
                      "rule_conditions": [
                        {
                          "condition_type": "categorical",
                          "value_filter": "filter-foo"
                        }
                      ]
                    }
                  ]}]
            },
            "data_description" : {
                "field_delimiter":",",
                "time_field":"time",
                "time_format":"yyyy-MM-dd HH:mm:ssX"
            }
          }
  - do:
      catch: conflict
      xpack.ml.delete_filter:
        filter_id: "filter-foo"

---
"Test non-existing filter":
  - do:
      catch: missing
      xpack.ml.delete_filter:
        filter_id: "does_not_exist"

---
"Test valid delete filter":

  - do:
      xpack.ml.get_filters:
        filter_id: "filter-foo"

  - match: { count:   1 }
  - match:
      filters.0:
        id: "filter-foo"
        items: ["abc", "xyz"]

  - do:
      xpack.ml.delete_filter:
        filter_id: "filter-foo"

  - do:
      catch: missing
      xpack.ml.get_filters:
        filter_id: "filter-foo"
