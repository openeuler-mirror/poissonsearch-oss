setup:
  - do:
      xpack.ml.put_job:
        job_id: job-1
        body:  >
          {
            "job_id":"job-1",
            "analysis_config" : {
                "bucket_span": "1h",
                "detectors" :[{"function":"count"}]
            },
            "data_description" : {
                "format":"xcontent",
                "time_field":"time",
                "time_format":"epoch"
            }
          }

  - do:
      xpack.ml.put_job:
        job_id: job-2
        body:  >
          {
            "job_id":"job-2",
            "analysis_config" : {
                "bucket_span": "1h",
                "detectors" :[{"function":"count"}]
            },
            "data_description" : {
                "time_field":"time"
            }
          }

  - do:
      xpack.ml.put_datafeed:
        datafeed_id: datafeed-1
        body: >
          {
            "job_id":"job-1",
            "indexes":["index-1"],
            "types":["type-1"]
          }

  - do:
      xpack.ml.put_datafeed:
        datafeed_id: datafeed-2
        body: >
          {
            "job_id":"job-2",
            "indexes":["index-2"],
            "types":["type-2"]
          }

---
"Test get datafeed stats given missing datafeed_id":

  - do:
      catch: missing
      xpack.ml.get_datafeed_stats:
        datafeed_id: missing-datafeed

---
"Test get single datafeed stats":

  - do:
      xpack.ml.get_datafeed_stats:
        datafeed_id: datafeed-1
  - match: { datafeeds.0.datafeed_id: "datafeed-1"}
  - match: { datafeeds.0.state: "stopped"}
  - is_false: datafeeds.0.node

  - do:
      xpack.ml.get_datafeed_stats:
        datafeed_id: datafeed-2
  - match: { datafeeds.0.datafeed_id: "datafeed-2"}
  - match: { datafeeds.0.state: "stopped"}
  - is_false: datafeeds.0.node

---
"Test get stats for started datafeed":

  - do:
      xpack.ml.open_job:
        job_id: job-1

  - do:
      xpack.ml.start_datafeed:
        "datafeed_id": "datafeed-1"
        "start": 0

  - do:
      xpack.ml.get_datafeed_stats:
        datafeed_id: datafeed-1
  - match: { datafeeds.0.datafeed_id: "datafeed-1"}
  - match: { datafeeds.0.state: "started"}
  - is_true: datafeeds.0.node.name
  - is_true: datafeeds.0.node.transport_address
  - match: { datafeeds.0.node.attributes.max_running_jobs: "10"}

---
"Test implicit get all datafeed stats given started datafeeds":

  - do:
      xpack.ml.open_job:
        job_id: job-1

  - do:
      xpack.ml.start_datafeed:
        "datafeed_id": "datafeed-1"
        "start": 0

  - do:
      xpack.ml.open_job:
        job_id: job-2

  - do:
      xpack.ml.start_datafeed:
        "datafeed_id": "datafeed-2"
        "start": 0

  - do:
      xpack.ml.get_datafeed_stats: {}
  - match: { count: 2 }
  - match: { datafeeds.0.datafeed_id: "datafeed-1"}
  - match: { datafeeds.0.state: "started"}
  - match: { datafeeds.1.datafeed_id: "datafeed-2"}
  - match: { datafeeds.1.state: "started"}

---
"Test explicit get all datafeed stats given stopped datafeeds":

  - do:
      xpack.ml.get_datafeed_stats:
        datafeed_id: _all
  - match: { count: 2 }
  - match: { datafeeds.0.datafeed_id: "datafeed-1"}
  - match: { datafeeds.0.state: "stopped"}
  - match: { datafeeds.1.datafeed_id: "datafeed-2"}
  - match: { datafeeds.1.state: "stopped"}

---
"Test implicit get all datafeed stats given stopped datafeeds":

  - do:
      xpack.ml.get_datafeed_stats: {}
  - match: { count: 2 }
  - match: { datafeeds.0.datafeed_id: "datafeed-1"}
  - match: { datafeeds.0.state: "stopped"}
  - match: { datafeeds.1.datafeed_id: "datafeed-2"}
  - match: { datafeeds.1.state: "stopped"}
