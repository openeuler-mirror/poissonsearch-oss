---
"Bulk indexing of monitoring data":

  - do:
      xpack.monitoring.bulk:
        system_id:          "kibana"
        system_api_version: "2"
        interval:           "10s"
        body:
          - index:
              _type:  test_type
          - avg-cpu:
              user:   13.26
              nice:   0.17
              system: 1.51
              iowait: 0.85
              idle:   84.20
          - index:
              _type:  test_type
          - avg-cpu:
              user:   13.23
              nice:   0.17
              system: 1.51
              iowait: 0.85
              idle:   84.24

  - is_false: errors

  - do:
      indices.refresh: {}

  - do:
      search:
        index: .monitoring-kibana-*
        type:  test_type

  - match: { hits.total: 2 }

  - do:
      xpack.monitoring.bulk:
        system_id:          "kibana"
        system_api_version: "2"
        interval:           "10000ms"
        type: "default_type"
        body:
          - '{"index": {}}'
          - '{"field_1": "value_1"}'
          - '{"index": {"_type": "custom_type"}}'
          - '{"field_1": "value_2"}'
          - '{"index": {}}'
          - '{"field_1": "value_3"}'
          - '{"index": {"_index": "_data", "_type": "kibana"}}'
          - '{"field_1": "value_4"}'

  - is_false: errors

  - do:
      indices.refresh: {}

  - do:
      search:
        index: .monitoring-kibana-*
        type:  default_type

  - match: { hits.total: 2 }

  - do:
      search:
        index: .monitoring-kibana-*
        type:  custom_type

  - match: { hits.total: 1 }

  # We actively ignore indexing requests made to .monitoring-data-N starting with 5.5
  - do:
      search:
        index: .monitoring-data-*
        type:  kibana

  - match: { hits.total: 0 }

  # Missing a system_id causes it to fail
  - do:
      catch: request
      xpack.monitoring.bulk:
        system_api_version: "2"
        interval:           "10s"
        type: "default_type"
        body:
          - '{"index": {}}'
          - '{"field_1": "value_1"}'

  # Missing a system_api_version causes it to fail
  - do:
      catch: request
      xpack.monitoring.bulk:
        system_id:          "kibana"
        interval:           "10s"
        type: "default_type"
        body:
          - '{"index": {}}'
          - '{"field_1": "value_1"}'

  # Missing an interval causes it to fail
  - do:
      catch: request
      xpack.monitoring.bulk:
        system_id:          "kibana"
        system_api_version: "2"
        type: "default_type"
        body:
          - '{"index": {}}'
          - '{"field_1": "value_1"}'
