setup:
  - do:
      indices.create:
          index: test_1
          body:
            settings:
              number_of_replicas: 0
            mappings:
              test:
                properties:
                  str:
                     type: keyword
                  ip:
                     type: ip

  - do:
      cluster.health:
        wait_for_status: green

---
"Basic test":
  - do:
      index:
        index: test_1
        type: test
        id: 1
        body: { "str" : "abc" }

  - do:
      index:
        index: test_1
        type: test
        id: 2
        body: { "str": "abc" }

  - do:
      index:
        index: test_1
        type: test
        id: 3
        body: { "str": "bcd" }
      
  - do:
      indices.refresh: {}
    
  - do:
      search:
        body: { "aggs" : { "str_terms" : { "terms" : { "field" : "str" } } } }

  - match: { hits.total: 3 }
  
  - length: { aggregations.str_terms.buckets: 2 }
  
  - match: { aggregations.str_terms.buckets.0.key: "abc" }
  
  - is_false: aggregations.str_terms.buckets.0.key_as_string
  
  - match: { aggregations.str_terms.buckets.0.doc_count: 2 }
  
  - match: { aggregations.str_terms.buckets.1.key: "bcd" }
  
  - is_false: aggregations.str_terms.buckets.1.key_as_string
  
  - match: { aggregations.str_terms.buckets.1.doc_count: 1 }
  
---
"IP test":
  - do:
      index:
        index: test_1
        type: test
        id: 1
        body: { "ip": "::1" }

  - do:
      index:
        index: test_1
        type: test
        id: 2
        body: { "ip": "127.0.0.1" }

  - do:
      index:
        index: test_1
        type: test
        id: 3
        body: { "ip": "::1" }

  - do:
      indices.refresh: {}

  - do:
      search:
        body: { "aggs" : { "ip_terms" : { "terms" : { "field" : "ip" } } } }

  - match: { hits.total: 3 }

  - length: { aggregations.ip_terms.buckets: 2 }

  - match: { aggregations.ip_terms.buckets.0.key: "::1" }

  - is_false: aggregations.ip_terms.buckets.0.key_as_string

  - match: { aggregations.ip_terms.buckets.0.doc_count: 2 }

  - match: { aggregations.ip_terms.buckets.1.key: "127.0.0.1" }
  
  - is_false: aggregations.ip_terms.buckets.1.key_as_string
  
  - match: { aggregations.ip_terms.buckets.1.doc_count: 1 }
