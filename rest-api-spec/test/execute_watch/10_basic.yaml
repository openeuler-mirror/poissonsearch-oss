---
"Test execute watch api":
  - do:
      cluster.health:
          wait_for_status: green

  - do:
      watcher.put_watch:
        id: "my_exe_watch"
        body:  > 
          {
            "trigger" : {
              "schedule" : { "cron" : "0 0 0 1 * ? 2099" }
            },
            "input" : {
              "search" : {
                "request" : {
                  "indices" : [ "logstash*" ],
                  "body" : {
                    "query" : {
                      "filtered": {
                        "query": {
                          "match": {
                            "response": 404
                          }
                        },
                        "filter": {
                          "range": {
                            "@timestamp" : {
                              "from": "{{ctx.trigger.scheduled_time}}||-5m",
                              "to": "{{ctx.trigger.triggered_time}}"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            "condition" : {
              "script" : {
                "inline" : "ctx.payload.hits.total > 1"
              }
            },
            "actions" : {
              "email_admin" : {
                "email" : {
                  "to" : "someone@domain.host.com",
                  "subject" : "404 recently encountered"
                }
              }
            }
          }
  - match: { _id: "my_exe_watch" }

  - do:
      watcher.execute_watch:
        id: "my_exe_watch"
        body: >
          {
            "ignore_condition" : true,
            "ignore_throttle" : true,
            "simulated_actions" : "_all",
            "alternative_input" : {
              "foo" : "bar"
            },
            "trigger_event" : {
              "schedule" : {
                "scheduled_time" : "2015-05-05T20:58:02.443Z",
                "triggered_time" : "2015-05-05T20:58:02.443Z"
              }
            },
            "record_execution" : true
          }
  - match: { "watch_id": "my_exe_watch" }
  - match: { "state": "executed" }
  - match: { "trigger_event.manual.schedule.scheduled_time": "2015-05-05T20:58:02.443Z" }
  - match: { "execution_result.condition.always": {} }
  - match: { "execution_result.input.simple.payload.foo": "bar" }
  - match: { "execution_result.actions.0.id" : "email_admin" }
  - match: { "execution_result.actions.0.email.success" : true }
  - match: { "execution_result.actions.0.email.simulated_email.subject" : "404 recently encountered" }
