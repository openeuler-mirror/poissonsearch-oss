---
"Test url escaping with url mustache function":
  - do:
      cluster.health:
          wait_for_status: yellow

  - do:
      index:
        index:   <date-index-{now/d}>
        type:    log
        id:      1
        refresh: true
        body:    { foo: bar }

  - do: {xpack.watcher.stats:{}}
  - match: { "watcher_state": "started" }
  - match: { "watch_count": 0 }

  - do:
      xpack.watcher.put_watch:
          id: "test_watch"
          body:  >
            {
              "metadata" : {
                "index" : "<date-index-{now/d}>"
              },
              "trigger": {
                "schedule": {
                  "interval": "1h"
                }
              },
              "input": {
                "http" : {
                  "request" : {
                    "host" : "localhost",
                    "port" : 9400,
                    "path" : "/{{#url}}{{ctx.metadata.index}}{{/url}}/_search"
                  }
                }
              },
              "condition" : {
                "compare" : {
                  "ctx.payload.hits.total" : {
                    "eq" : 1
                  }
                }
              },
              "actions": {
                "output": {
                  "webhook" : {
                    "method" : "PUT",
                    "host" : "localhost",
                    "port" : 9400,
                    "path" : "/{{#url}}{{ctx.metadata.index}}{{/url}}/log/2",
                    "params" : {
                      "refresh" : "true"
                    },
                    "body" : "{ \"foo\": \"bar\" }"
                  }
                }
              }
            }

  - match: { _id: "test_watch" }
  - match: { created: true }

  - do:
      xpack.watcher.execute_watch:
          id: "test_watch"

  - do:
      count:
          index: <date-index-{now/d}>
          type: log

  - match: {count : 2}

