# When a script is specified in a watch, updates should be taken into account
# See https://github.com/elastic/x-plugins/issues/4237
---
"Test transform scripts are updated on execution":
  - do:
    cluster.health:
      wait_for_status: yellow

  - do:
    put_script:
      id: transform-script
      lang: painless
      body: >
        {
          "script":"return [ 'email': 'foo@bar.org' ]"
        }

  - do:
      xpack.watcher.put_watch:
        id: "my_watch"
        body:  >
          {
            "trigger": {
              "schedule": {
                "interval": "1h"
              }
            },
            "input": {
              "simple": {}
            },
            "transform": {
              "script": {
                "stored": "transform-script"
              }
            },
            "actions": {
              "my_log": {
                "logging": {
                  "text": "{{ctx}}"
                }
              }
            }
          }

  - match: { _id: "my_watch" }

  - do:
      xpack.watcher.execute_watch:
        id: "my_watch"

  - match: { "watch_record.watch_id": "my_watch" }
  - match: { "watch_record.result.transform.payload.email": "foo@bar.org" }

  - do:
    put_script:
      id: transform-script
      lang: painless
      body: >
        {
          "script":"return [ 'email': 'foo@example.org' ]"
        }

  - do:
      xpack.watcher.execute_watch:
        id: "my_watch"

  - match: { "watch_record.watch_id": "my_watch" }
  - match: { "watch_record.result.transform.payload.email": "foo@example.org" }

---
"Test condition scripts are updated on execution":
  - do:
    cluster.health:
      wait_for_status: yellow

  - do:
    put_script:
      id: condition-script
      lang: painless
      body: >
        {
          "script":"return false"
        }

  - do:
      xpack.watcher.put_watch:
        id: "my_watch"
        body:  >
          {
            "trigger": {
              "schedule": {
                "interval": "1h"
              }
            },
            "input": {
              "simple": {}
            },
            "condition": {
              "script": {
                "stored": "condition-script"
              }
            },
            "actions": {
              "my_log": {
                "logging": {
                  "text": "{{ctx}}"
                }
              }
            }
          }

  - match: { _id: "my_watch" }

  - do:
      xpack.watcher.execute_watch:
        id: "my_watch"

  - match: { "watch_record.watch_id": "my_watch" }
  - match: { "watch_record.result.condition.met": false }

  - do:
    put_script:
      id: condition-script
      lang: painless
      body: >
        {
          "script":"return true"
        }

  - do:
      xpack.watcher.execute_watch:
        id: "my_watch"

  - match: { "watch_record.watch_id": "my_watch" }
  - match: { "watch_record.result.condition.met": true }

