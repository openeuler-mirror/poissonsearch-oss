---
setup:
  - skip:
      features: headers

  - do:
      cluster.health:
        wait_for_status: yellow

  - do:
      xpack.security.put_user:
        username: "inline_template_user"
        body:  >
            {
              "password": "changeme",
              "roles" : [ "inline_template_role" ]
            }
  - do:
      xpack.security.put_user:
        username: "stored_template_user"
        body:  >
            {
              "password": "changeme",
              "roles" : [ "stored_template_role" ]
            }

  - do:
      xpack.security.put_user:
        username: "file_template_user"
        body:  >
            {
              "password": "changeme",
              "roles" : [ "file_template_role" ]
            }
  - do:
      xpack.security.put_user:
        username: "terms_template_user"
        body:  >
            {
              "password": "changeme",
              "roles" : [ "terms_template_role" ],
              "metadata": {
                "groups": [ "inline_template_user", "file_template_user" ]
              }
            }

  - do:
      xpack.security.put_role:
        name: "inline_template_role"
        body:  >
            {
              "indices": [
                {
                  "names": "foobar",
                  "privileges": ["all"],
                  "query" : {
                    "template" : {
                      "inline" : {
                        "term" : { "username" : "{{_user.username}}" }
                      }
                    }
                  }
                }
              ]
            }

  - do:
      xpack.security.put_role:
        name: "terms_template_role"
        body:  >
            {
              "indices": [
                {
                  "names": "foobar",
                  "privileges": ["all"],
                  "query" : {
                    "template" : {
                      "inline" : "{\"terms\" : { \"username\" : {{#toJson}}_user.metadata.groups{{/toJson}} } }"
                    }
                  }
                }
              ]
            }

  - do:
      xpack.security.put_role:
        name: "stored_template_role"
        body:  >
            {
              "indices": [
                {
                  "names": "foobar",
                  "privileges": ["all"],
                  "query" : {
                    "template" : {
                      "stored" : "1"
                    }
                  }
                }
              ]
            }

  - do:
      xpack.security.put_role:
        name: "file_template_role"
        body:  >
            {
              "indices": [
                {
                  "names": "foobar",
                  "privileges": ["all"],
                  "query" : {
                    "template" : {
                      "file" : "query"
                    }
                  }
                }
              ]
            }

  - do:
      put_template:
        id: "1"
        body: >
            {
              "term" : {
                "username" : "{{_user.username}}"
              }
            }

  - do:
      index:
        index: foobar
        type: type
        id: 1
        body:  >
          {
            "username": "inline_template_user"
          }
  - do:
      index:
        index: foobar
        type: type
        id: 2
        body:  >
          {
            "username": "stored_template_user"
          }
  - do:
      index:
        index: foobar
        type: type
        id: 3
        body:  >
          {
            "username": "file_template_user"
          }

  - do:
      indices.refresh: {}

---
teardown:
  - do:
      xpack.security.delete_user:
        username: "inline_template_user"
        ignore: 404
  - do:
      xpack.security.delete_user:
        username: "stored_template_user"
        ignore: 404
  - do:
      xpack.security.delete_user:
        username: "file_template_user"
        ignore: 404
  - do:
      xpack.security.delete_user:
        username: "terms_template_user"
        ignore: 404
  - do:
      xpack.security.delete_role:
        name: "inline_template_role"
        ignore: 404
  - do:
      xpack.security.delete_role:
        name: "stored_template_role"
        ignore: 404
  - do:
      xpack.security.delete_role:
        name: "file_template_role"
        ignore: 404
  - do:
      xpack.security.delete_role:
        name: "terms_template_role"
        ignore: 404
---
"Test inline template with run as":
  - do:
      headers:
        es-security-runas-user: "inline_template_user"
      search:
        index: foobar
        body: { "query" : { "match_all" : {} } }
  - match: { hits.total: 1}
  - match: { hits.hits.0._source.username: inline_template_user}

---
"Test stored template with run as":
  - do:
      headers:
        es-security-runas-user: "stored_template_user"
      search:
        index: foobar
        body: { "query" : { "match_all" : {} } }
  - match: { hits.total: 1}
  - match: { hits.hits.0._source.username: stored_template_user}

---
"Test file template with run as":
  - do:
      headers:
        es-security-runas-user: "file_template_user"
      search:
        index: foobar
        body: { "query" : { "match_all" : {} } }
  - match: { hits.total: 1}
  - match: { hits.hits.0._source.username: file_template_user}

---
"Test terms template with run as":
  - do:
      headers:
        es-security-runas-user: "terms_template_user"
      search:
        index: foobar
        body: { "query" : { "match_all" : {} } }
  - match: { hits.total: 2}
  - match: { hits.hits.0._source.username: inline_template_user}
  - match: { hits.hits.1._source.username: file_template_user}
