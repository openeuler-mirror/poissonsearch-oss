setup:
  - do:
      xpack.prelert.put_job:
        body:  >
          {
            "job_id":"job-stats-test",
            "description":"Analysis of response time by airline",
            "analysis_config" : {
                "bucket_span":3600,
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
                "format":"JSON",
                "time_field":"time",
                "time_format":"epoch"
            }
          }

  - do:
      xpack.prelert.open_job:
        job_id: job-stats-test

  - do:
      xpack.prelert.put_job:
        body:  >
          {
            "job_id":"scheduled-job",
            "description":"A job with a scheduler",
            "analysis_config" : {
                "bucket_span":3600,
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
                "format" : "ELASTICSEARCH",
                "time_field":"time",
                "time_format":"yyyy-MM-dd'T'HH:mm:ssX"
            },
            "scheduler_config": {
                "indexes":["farequote"],
                "types":["response"]
            }
          }
  - do:
      xpack.prelert.open_job:
        job_id: scheduled-job

  - do:
      index:
        index:  prelertresults-job-stats-test
        type:   model_size_stats
        id:     model_size_stats
        body:   {
                  "job_id": "job-stats-test",
                  "log_time": 1480896000000,
                  "timestamp": 1480896000000,
                  "model_bytes": 100,
                  "total_by_field_count": 2
                }

---
"Test get job stats after uploading data prompting the creation of some stats":
  - do:
      xpack.prelert.get_jobs:
        job_id: job-stats-test

  - is_true: jobs.0.config
  - is_false: jobs.0.data_counts
  - is_false: jobs.0.model_size_stats
  - is_false: jobs.0.scheduler_state


  - do:
      xpack.prelert.post_data:
        job_id: job-stats-test
        body: >
          {"airline":"AAL","responsetime":"132.2046","time":"1403481600"}
          {"airline":"JZA","responsetime":"990.4628","time":"1403481600"}

  - do:
      xpack.prelert.flush_data:
        job_id: job-stats-test
  - match: { acknowledged: true }


  - do:
      xpack.prelert.get_jobs:
        job_id: job-stats-test
        metric: data_counts

  - match: { jobs.0.job_id : job-stats-test }
  - match: { jobs.0.data_counts.processed_record_count: 2 }
  - match: { jobs.0.data_counts.processed_field_count: 4}
  - match: { jobs.0.data_counts.input_field_count: 4 }

# Test filters
  - do:
      xpack.prelert.get_jobs:
        job_id: "job-stats-test"
        metric: "data_counts"
  - is_false: jobs.0.config
  - is_true: jobs.0.data_counts
  - is_false: jobs.0.model_size_stats
  - is_false: jobs.0.scheduler_state

  - do:
      xpack.prelert.get_jobs:
        job_id: "job-stats-test"
        metric: "model_size_stats"
  - is_false: jobs.0.config
  - is_false: jobs.0.data_counts
  - is_false: jobs.0.scheduler_state
  - match: { jobs.0.model_size_stats.model_bytes: 100 }

  - do:
      xpack.prelert.get_jobs:
        job_id: "job-stats-test"
        metric: "scheduler_state"
  - is_false: jobs.0.config
  - is_false: jobs.0.data_counts

  - do:
      xpack.prelert.get_jobs:
        job_id: "job-stats-test"
        metric: "status"
  - is_false: jobs.0.config
  - is_false: jobs.0.data_counts
  - is_false: jobs.0.model_size_stats
  - is_false: jobs.0.scheduler_state
  - match: { jobs.0.status: OPENED }

  - do:
      xpack.prelert.get_jobs:
        job_id: "job-stats-test"
        metric: "_all"
  - is_true: jobs.0.config
  - is_true: jobs.0.data_counts
  - is_false: jobs.0.scheduler_state
  - match: { jobs.0.job_id: job-stats-test }
  - match: { jobs.0.status: OPENED }

  - do:
      xpack.prelert.get_jobs:
        job_id: "scheduled-job"
        metric: "scheduler_state"
  - is_false: jobs.0.config
  - is_false: jobs.0.data_counts
  - is_false: jobs.0.model_size_stats
  - match: { jobs.0.scheduler_state.status: STOPPED }

---
"Test bad metric":
  - do:
      catch: request
      xpack.prelert.get_jobs:
        job_id: "job-stats-test"
        metric: "foobar"

