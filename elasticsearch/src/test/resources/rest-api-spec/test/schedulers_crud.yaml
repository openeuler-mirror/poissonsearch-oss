setup:
  - do:
      xpack.ml.put_job:
        job_id: job-1
        body:  >
          {
            "job_id":"job-1",
            "analysis_config" : {
                "bucket_span":3600,
                "detectors" :[{"function":"count"}]
            },
            "data_description" : {
                "format":"JSON",
                "time_field":"time",
                "time_format":"epoch"
            }
          }

  - do:
      xpack.ml.put_job:
        job_id: job-2
        body:  >
          {
            "analysis_config" : {
                "bucket_span":3600,
                "detectors" :[{"function":"count"}]
            },
            "data_description" : {
                "time_field":"time"
            }
          }

---
"Test get all schedulers and stats given no scheduler exists":

  - do:
      xpack.ml.get_schedulers:
        scheduler_id: "_all"
  - match: { count: 0 }
  - match: { schedulers: [] }

  - do:
      xpack.ml.get_schedulers_stats:
        scheduler_id: "_all"
  - match: { count: 0 }
  - match: { schedulers: [] }

---
"Test put scheduler referring to missing job_id":
  - do:
      catch: /resource_not_found_exception/
      xpack.ml.put_scheduler:
        scheduler_id: test-scheduler-1
        body:  >
          {
            "job_id":"a-missing-job",
            "indexes":["index-foo"],
            "types":["type-bar"]
          }

---
"Test put scheduler referring to existing job_id":
  - do:
      xpack.ml.put_scheduler:
        scheduler_id: test-scheduler-1
        body:  >
          {
            "job_id":"job-1",
            "indexes":["index-foo"],
            "types":["type-bar"]
          }
  - match: { scheduler_id: "test-scheduler-1" }

---
"Test put scheduler whose id is already taken":
  - do:
      xpack.ml.put_scheduler:
        scheduler_id: test-scheduler-1
        body:  >
          {
            "job_id":"job-1",
            "indexes":["index-foo"],
            "types":["type-bar"]
          }
  - match: { scheduler_id: "test-scheduler-1" }

  - do:
      catch: /resource_already_exists_exception/
      xpack.ml.put_scheduler:
        scheduler_id: test-scheduler-1
        body:  >
          {
            "job_id":"job-2",
            "indexes":["index-foo"],
            "types":["type-bar"]
          }

---
"Test put scheduler with job_id that is already used by another scheduler":
  - do:
      xpack.ml.put_scheduler:
        scheduler_id: test-scheduler-1
        body:  >
          {
            "job_id":"job-1",
            "indexes":["index-foo"],
            "types":["type-bar"]
          }
  - match: { scheduler_id: "test-scheduler-1" }

  - do:
      catch: /A scheduler \[test-scheduler-1\] already exists for job \[job-1\]/
      xpack.ml.put_scheduler:
        scheduler_id: test-scheduler-2
        body:  >
          {
            "job_id":"job-1",
            "indexes":["index-foo"],
            "types":["type-bar"]
          }

---
"Test put scheduler with invalid query":
  - do:
      catch: /parsing_exception/
      xpack.ml.put_scheduler:
        scheduler_id: test-scheduler-1
        body:  >
          {
            "job_id":"job-1",
            "indexes":["index-foo"],
            "types":["type-bar"],
            "query":{"match_all_mispelled":{}}
          }

---
"Test delete scheduler with missing id":
  - do:
      catch: /resource_not_found_exception/
      xpack.ml.delete_scheduler:
        scheduler_id: a-missing-scheduler

---
"Test delete scheduler":
  - do:
      xpack.ml.put_scheduler:
        scheduler_id: test-scheduler-1
        body:  >
          {
            "job_id":"job-1",
            "indexes":["index-foo"],
            "types":["type-bar"]
          }
  - match: { scheduler_id: "test-scheduler-1" }

  - do:
      xpack.ml.delete_scheduler:
        scheduler_id: test-scheduler-1
  - match: { acknowledged: true }
