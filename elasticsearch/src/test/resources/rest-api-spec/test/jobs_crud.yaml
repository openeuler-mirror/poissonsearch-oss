---
"Test get all jobs and stats given no job exists":

  - do:
      xpack.ml.get_jobs:
        job_id: "_all"
  - match: { count: 0 }
  - match: { jobs: [] }

  - do:
      xpack.ml.get_job_stats:
        job_id: "_all"
  - match: { count: 0 }
  - match: { jobs: [] }

---
"Test job crud apis":

  - do:
      xpack.ml.put_job:
        job_id: farequote
        body:  >
          {
            "description":"Analysis of response time by airline",
            "analysis_config" : {
                "bucket_span":3600,
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
                "field_delimiter":",",
                "time_field":"time",
                "time_format":"yyyy-MM-dd HH:mm:ssX"
            }
          }
  - match: { job_id: "farequote" }

  - do:
      indices.get:
        index: ".ml-anomalies-farequote"

  - do:
      indices.get:
        index: ".ml-state"

  - do:
      xpack.ml.get_jobs:
        job_id: "farequote"
  - match: { count: 1 }
  - match: { jobs.0.job_id: "farequote" }

  - do:
      xpack.ml.delete_job:
        job_id: "farequote"
  - match: { acknowledged: true }

  - do:
      indices.exists:
        index: ".ml-anomalies-farequote"
  - is_false: ''

---
"Test get job API with non existing job id":
  - do:
      catch: missing
      xpack.ml.get_jobs:
        job_id: "non-existing"

---
"Test put job with inconsistent body/param ids":
  - do:
      catch: /illegal_argument_exception/
      xpack.ml.put_job:
        job_id: an_id
        body:  >
          {
            "job_id":"a_different_id",
            "description":"Analysis of response time by airline",
            "analysis_config" : {
                "bucket_span":3600,
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
                "field_delimiter":",",
                "time_field":"time",
                "time_format":"yyyy-MM-dd HH:mm:ssX"
            }
          }

  - do:
      catch: /Inconsistent job_id; 'a_different_id' specified in the body differs from 'an_id' specified as a URL argument/
      xpack.ml.put_job:
        job_id: an_id
        body:  >
          {
            "job_id":"a_different_id",
            "description":"Analysis of response time by airline",
            "analysis_config" : {
                "bucket_span":3600,
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
                "field_delimiter":",",
                "time_field":"time",
                "time_format":"yyyy-MM-dd HH:mm:ssX"
            }
          }

---
"Test put job with id that is already taken":
  - do:
      xpack.ml.put_job:
        job_id: farequote
        body:  >
          {
            "job_id":"farequote",
            "description":"Analysis of response time by airline",
            "analysis_config" : {
                "bucket_span":3600,
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
                "field_delimiter":",",
                "time_field":"time",
                "time_format":"yyyy-MM-dd HH:mm:ssX"
            }
          }
  - match: { job_id: "farequote" }

  - do:
      catch: /resource_already_exists_exception/
      xpack.ml.put_job:
        job_id: farequote
        body:  >
          {
            "job_id":"farequote",
            "description":"Analysis of response time by airline",
            "analysis_config" : {
                "bucket_span":3600,
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
                "field_delimiter":",",
                "time_field":"time",
                "time_format":"yyyy-MM-dd HH:mm:ssX"
            }
          }
  - do:
      catch: /The job cannot be created with the Id 'farequote'. The Id is already used./
      xpack.ml.put_job:
        job_id: farequote
        body:  >
          {
            "job_id":"farequote",
            "description":"Analysis of response time by airline",
            "analysis_config" : {
                "bucket_span":3600,
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
                "field_delimiter":",",
                "time_field":"time",
                "time_format":"yyyy-MM-dd HH:mm:ssX"
            }
          }
  - do:
      catch: param
      xpack.ml.put_job:
        job_id: farequote
        body:  >
          {
            "job_id":"farequote",
            "description":"Analysis of response time by airline",
            "analysis_config" : {
                "bucket_span":3600,
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
                "field_delimiter":",",
                "time_field":"time",
                "time_format":"yyyy-MM-dd HH:mm:ssX"
            }
          }

---
"Test delete job that is referred by a datafeed":
  - do:
      xpack.ml.put_job:
        job_id: datafeed-job
        body:  >
          {
            "job_id":"datafeed-job",
            "description":"Analysis of response time by airline",
            "analysis_config" : {
                "bucket_span":3600,
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
                "format":"JSON",
                "time_field":"time",
                "time_format":"yyyy-MM-dd HH:mm:ssX"
            }
          }
  - match: { job_id: "datafeed-job" }

  - do:
      xpack.ml.put_datafeed:
        datafeed_id: test-datafeed-1
        body:  >
          {
            "job_id":"datafeed-job",
            "indexes":["index-foo"],
            "types":["type-bar"]
          }
  - match: { datafeed_id: "test-datafeed-1" }

  - do:
      catch: /Cannot delete job \[datafeed-job\] while datafeed \[test-datafeed-1\] refers to it/
      xpack.ml.delete_job:
        job_id: datafeed-job
