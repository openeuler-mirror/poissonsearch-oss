---
"Test overwriting a user":
  - skip:
      features: headers

  - do:
      cluster.health:
          wait_for_status: yellow

  - do:
      shield.put_user:
        username: "joe"
        body:  >
            {
              "username": "joe",
              "password": "s3krit",
              "roles" : [ "admin" ]
            }
  - match: { user: { created: true } }

  - do:
      shield.get_user:
        username: "joe"
  - match: { found: true }
  - match: { users.0.username: "joe" }
  - match: { users.0.roles.0:  "admin" }

  - do:
      headers:
        Authorization: "Basic am9lOnMza3JpdA=="
      cluster.health: {}
  - match: { timed_out: false }

  - do:
      shield.put_user:
        username: "joe"
        body:  >
            {
              "username" : "joe",
              "password" : "s3krit2",
              "roles" : [ "admin", "foo" ],
              "full_name" : "Bazooka Joe",
              "email" : "joe@bazooka.gum",
              "metadata" : {
                "key1" : "val1",
                "key2" : "val2"
              }
            }
  - match: { user: { created: false } }

  - do:
      shield.get_user:
        username: "joe"
  - match: { found: true }
  - match: { users.0.username: "joe" }
  - match: { users.0.roles.0:  "admin" }
  - match: { users.0.roles.1:  "foo" }
  - match: { users.0.full_name:  "Bazooka Joe" }
  - match: { users.0.email:  "joe@bazooka.gum" }
  - match: { users.0.metadata.key1:  "val1" }
  - match: { users.0.metadata.key2:  "val2" }

  - do:
      headers:
        Authorization: "Basic am9lOnMza3JpdDI="
      cluster.health: {}
  - match: { timed_out: false }
