---
"Basic array_compare watch":

  - skip:
      version:     " - "
      reason:      Remove direct dependency on mustache (or at least it should be using xmustache!!!!)

  - do:
      cluster.health:
          wait_for_status: yellow


  - do: {watcher.stats:{}}
  - match: { "watcher_state": "started" }
  - match: { "watch_count": 0 }

  - do:
      watcher.put_watch:
        id: "array-compare-watch"
        body:  >
          {
            "trigger": {
              "schedule": {
                "interval": "1s"
              }
            },
            "input": {
              "search": {
                "request": {
                  "indices": [ "test_1" ],
                  "body": {
                    "aggs": {
                      "top_foos": {
                        "terms": {
                          "field": "foo",
                          "size": 1
                        }
                      }
                    }
                  }
                }
              }
            },
            "condition": {
              "array_compare": {
                "ctx.payload.aggregations.top_foos.buckets": {
                  "path": "doc_count",
                  "gte": {
                    "value": 3,
                    "quantifier": "some"
                  }
                }
              }
            },
            "actions": {
              "log": {
                "logging": {
                  "text": "executed at {{ctx.execution_time}}"
                }
              }
            }
          }
  - match: { _id: "array-compare-watch" }
  - match: { created: true }

  - do:
      index:
          index:  test_1
          type:   test
          id:     1
          body:   { foo: bar }

  - do:
      index:
          index:  test_1
          type:   test
          id:     2
          body:   { foo: bar }

  - do:
      index:
          index:  test_1
          type:   test
          id:     3
          body:   { foo: bar }

  - do:
      index:
          index:  test_1
          type:   test
          id:     4
          body:   { foo: baz }
  - do:
      indices.refresh: {}

  - do: {watcher.stats:{}}
  - match: { "watch_count": 1 }

  # Simulate a Thread.sleep()
  - do:
      catch: request_timeout
      cluster.health:
        wait_for_nodes: 99
        timeout: 10s
  - match: { "timed_out": true }

  - do:
      indices.refresh:
        index: .watch_history-*

  - do:
      search:
        index: .watch_history-*
        body: >
          {
            "query": {
              "bool": {
                "must" : [
                  {
                    "term": {
                      "watch_id": {
                        "value": "array-compare-watch"
                      }
                    }
                  },
                  {
                    "term": {
                       "result.condition.met": {
                         "value": "true"
                       }
                    }
                  }
                ]
              }
            }
          }
  - gte:  { hits.total: 1 }

  - do:
      watcher.delete_watch:
        id: "array-compare-watch"
  - match: { found: true }


  - do: {watcher.stats:{}}
  - match: { "watch_count": 0 }
