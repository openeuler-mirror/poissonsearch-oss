<?xml version="1.0"?>
<project name="commercial-integration-tests">

  <import file="${elasticsearch.integ.antfile.default}"/>

  <property name="integ.args" value="
-Des.cluster.name=${integ.cluster.name}
-Des.http.port=${integ.http.port}
-Des.transport.tcp.port=${integ.transport.port}
-Des.pidfile=${integ.pidfile}
-Des.discovery.zen.ping.multicast.enabled=false
-Des.script.inline=on
-Des.script.indexed=on
-Des.repositories.url.allowed_urls=http://snapshot.test*
  "/>


  <!-- TODO shield redefines this because the wait for http will fail due to auth -->
  <!-- TODO: remove this, its really fragile as shit -->
  <macrodef name="startup-elasticsearch">
    <attribute name="home" default="${integ.scratch}/elasticsearch-${elasticsearch.version}"/>
    <attribute name="args" default="${integ.args}"/>
    <sequential>
      <echo>Starting up external cluster...</echo>
      <run-script script="@{home}/bin/elasticsearch" spawn="true"
                  args="@{args} -Des.path.repo=@{home}/repo" />

      <waitfor maxwait="3" maxwaitunit="minute" checkevery="500">
        <socket server="127.0.0.1" port="${integ.http.port}"/>
      </waitfor>

      <local name="integ.pid"/>
      <extract-pid file="${integ.pidfile}" property="integ.pid"/>
      <echo>External cluster started PID ${integ.pid}</echo>
    </sequential>
  </macrodef>

  <target name="start-external-cluster-with-plugin" depends="setup-workspace">
    <local name="home"/>
    <property name="home" location="${integ.scratch}/elasticsearch-${elasticsearch.version}"/>
    <install-plugin name="elasticsearch-license" file="${integ.deps}/elasticsearch-license-plugin-${project.version}.zip" />
    <install-plugin name="${project.artifactId}" file="${project.build.directory}/releases/${project.artifactId}-${project.version}.zip"/>
    <run-script script="${home}/bin/shield/esusers" args="useradd test_user -p changeme -r admin"/>
    <startup-elasticsearch/>

    <local name="temp.file"/>
    <tempfile property="temp.file" destdir="${java.io.tmpdir}"/>
    <get src="http://127.0.0.1:${integ.http.port}" dest="${temp.file}" username="test_user" password="changeme" verbose="true" retries="10"/>
  </target>
</project>
